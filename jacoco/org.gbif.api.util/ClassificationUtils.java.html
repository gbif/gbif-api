<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ClassificationUtils.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GBIF Common :: API</a> &gt; <a href="index.source.html" class="el_package">org.gbif.api.util</a> &gt; <span class="el_source">ClassificationUtils.java</span></div><h1>ClassificationUtils.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2020 Global Biodiversity Information Facility (GBIF)
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.gbif.api.util;

import org.gbif.api.model.common.LinneanClassification;
import org.gbif.api.model.common.LinneanClassificationKeys;
import org.gbif.api.vocabulary.Rank;

import java.util.LinkedHashMap;
import java.util.Objects;
import java.util.stream.Collectors;
import java.util.stream.Stream;

import javax.annotation.Nullable;
import javax.validation.constraints.NotNull;

import org.apache.commons.lang3.StringUtils;

@SuppressWarnings(&quot;unused&quot;)
public class ClassificationUtils {

  /**
   * Concatenates all higher Linnean taxa into a single dwc:higherClassification string, skipping
   * null values.
   *
   * @param lc the LinneanClassification to join into the higher classification string
   *
   * @return the concatenated dwc:higherClassification string
   */
  @Nullable
  public static String getHigherClassification(LinneanClassification lc) {
<span class="nc" id="L45">    return ApiStringUtils.emptyToNull(</span>
<span class="nc" id="L46">      Stream.of(lc.getKingdom(), lc.getPhylum(), lc.getClazz(),</span>
<span class="nc" id="L47">        lc.getOrder(), lc.getFamily(), lc.getGenus())</span>
<span class="nc" id="L48">        .filter(Objects::nonNull)</span>
<span class="nc" id="L49">        .collect(Collectors.joining(&quot;, &quot;)));</span>
  }

  /**
   * Gets a higher taxon property by passing the rank of it.
   * Only Linnean ranks are supported.
   *
   * @param lc   the LinneanClassification holding the taxon property to be retrieved
   * @param rank the higher linnean rank to retrieve
   *
   * @return the name of the higher taxon or null if rank doesnt exist
   */
  @Nullable
  public static String getHigherRank(LinneanClassification lc, Rank rank) {
<span class="pc bpc" id="L63" title="1 of 2 branches missed.">    if (rank != null) {</span>
<span class="pc bpc" id="L64" title="8 of 9 branches missed.">      switch (rank) {</span>
        case KINGDOM:
<span class="fc" id="L66">          return lc.getKingdom();</span>
        case PHYLUM:
<span class="nc" id="L68">          return lc.getPhylum();</span>
        case CLASS:
<span class="nc" id="L70">          return lc.getClazz();</span>
        case ORDER:
<span class="nc" id="L72">          return lc.getOrder();</span>
        case FAMILY:
<span class="nc" id="L74">          return lc.getFamily();</span>
        case GENUS:
<span class="nc" id="L76">          return lc.getGenus();</span>
        case SUBGENUS:
<span class="nc" id="L78">          return lc.getSubgenus();</span>
        case SPECIES:
<span class="nc" id="L80">          return lc.getSpecies();</span>
      }
    }
<span class="nc" id="L83">    return null;</span>
  }

  /**
   * Sets a higher taxon property by passing the rank of it.
   *
   * @param lc   the LinneanClassification on which to set the new property
   * @param rank the higher linnean rank to set
   * @param name the higher ranks name
   */
  public static void setHigherRank(LinneanClassification lc, Rank rank, String name) {
<span class="fc bfc" id="L94" title="All 2 branches covered.">    if (rank != null) {</span>
<span class="pc bpc" id="L95" title="8 of 9 branches missed.">      switch (rank) {</span>
        case KINGDOM:
<span class="nc" id="L97">          lc.setKingdom(name);</span>
<span class="nc" id="L98">          break;</span>
        case PHYLUM:
<span class="nc" id="L100">          lc.setPhylum(name);</span>
<span class="nc" id="L101">          break;</span>
        case CLASS:
<span class="nc" id="L103">          lc.setClazz(name);</span>
<span class="nc" id="L104">          break;</span>
        case ORDER:
<span class="nc" id="L106">          lc.setOrder(name);</span>
<span class="nc" id="L107">          break;</span>
        case FAMILY:
<span class="nc" id="L109">          lc.setFamily(name);</span>
<span class="nc" id="L110">          break;</span>
        case GENUS:
<span class="fc" id="L112">          lc.setGenus(name);</span>
<span class="fc" id="L113">          break;</span>
        case SUBGENUS:
<span class="nc" id="L115">          lc.setSubgenus(name);</span>
<span class="nc" id="L116">          break;</span>
        case SPECIES:
<span class="nc" id="L118">          lc.setSpecies(name);</span>
          break;
      }
    }
<span class="fc" id="L122">  }</span>

  /**
   * An ordered map with entries for all higher Linnean ranks down to species which are not null.
   * The map starts with the highest rank, e.g. the kingdom and maps the name usage key to its canonical name.
   *
   * @param lc the object that implements both LinneanClassification and LinneanClassificationKeys from which to build
   *           the map
   *
   * @return map of higher ranks
   */
  @NotNull
  public static &lt;T extends LinneanClassification &amp; LinneanClassificationKeys&gt; LinkedHashMap&lt;Integer, String&gt; getHigherClassificationMap(
    T lc) {
<span class="fc" id="L136">    return getHigherClassificationBaseMap(lc);</span>
  }

  /**
   * An ordered map with entries for all higher Linnean ranks down to the actual direct parent of this usage.
   * The map starts with the highest rank, e.g. the kingdom and maps the name usage key to its canonical name.
   * The name usage itself is never included, even though a higher rank might point to the usage itself.
   *
   * @param lc the object that implements both LinneanClassification and LinneanClassificationKeys from which to build
   *           the map
   *
   * @return map of higher ranks
   */
  @NotNull
  public static &lt;T extends LinneanClassification &amp; LinneanClassificationKeys&gt; LinkedHashMap&lt;Integer, String&gt; getHigherClassificationMap(
    T lc, int key, Integer parentKey, String parent) {
<span class="fc" id="L152">    LinkedHashMap&lt;Integer, String&gt; map = getHigherClassificationBaseMap(lc);</span>

<span class="fc bfc" id="L154" title="All 2 branches covered.">    if (parentKey != null) {</span>
<span class="fc" id="L155">      map.put(parentKey, parent);</span>
    }
    // remove notion to this usage
<span class="fc" id="L158">    map.remove(key);</span>

<span class="fc" id="L160">    return map;</span>
  }

  private static &lt;T extends LinneanClassification &amp; LinneanClassificationKeys&gt; LinkedHashMap&lt;Integer, String&gt; getHigherClassificationBaseMap(
    T lc) {
<span class="fc" id="L165">    LinkedHashMap&lt;Integer, String&gt; map = new LinkedHashMap&lt;&gt;();</span>
<span class="pc bpc" id="L166" title="1 of 2 branches missed.">    if (lc.getKingdomKey() != null) {</span>
<span class="fc" id="L167">      map.put(lc.getKingdomKey(), lc.getKingdom());</span>
    }
<span class="fc bfc" id="L169" title="All 2 branches covered.">    if (lc.getPhylumKey() != null) {</span>
<span class="fc" id="L170">      map.put(lc.getPhylumKey(), lc.getPhylum());</span>
    }
<span class="pc bpc" id="L172" title="1 of 2 branches missed.">    if (lc.getClassKey() != null) {</span>
<span class="nc" id="L173">      map.put(lc.getClassKey(), lc.getClazz());</span>
    }
<span class="fc bfc" id="L175" title="All 2 branches covered.">    if (lc.getOrderKey() != null) {</span>
<span class="fc" id="L176">      map.put(lc.getOrderKey(), lc.getOrder());</span>
    }
<span class="fc bfc" id="L178" title="All 2 branches covered.">    if (lc.getFamilyKey() != null) {</span>
<span class="fc" id="L179">      map.put(lc.getFamilyKey(), lc.getFamily());</span>
    }
<span class="fc bfc" id="L181" title="All 2 branches covered.">    if (lc.getGenusKey() != null) {</span>
<span class="fc" id="L182">      map.put(lc.getGenusKey(), lc.getGenus());</span>
    }
<span class="fc bfc" id="L184" title="All 2 branches covered.">    if (lc.getSpeciesKey() != null) {</span>
<span class="fc" id="L185">      map.put(lc.getSpeciesKey(), lc.getSpecies());</span>
    }
<span class="fc" id="L187">    return map;</span>
  }

  /**
   * Gets a higher taxon key by passing the rank of it.
   * Only Linnean ranks are supported.
   *
   * @param lck  the classification that holds the taxon key
   * @param rank the higher linnean rank to retrieve
   *
   * @return the key of the higher taxon or null if rank doesnt exist
   */
  @Nullable
  public static Integer getHigherRankKey(LinneanClassificationKeys lck, Rank rank) {
<span class="pc bpc" id="L201" title="1 of 2 branches missed.">    if (rank != null) {</span>
<span class="pc bpc" id="L202" title="8 of 9 branches missed.">      switch (rank) {</span>
        case KINGDOM:
<span class="fc" id="L204">          return lck.getKingdomKey();</span>
        case PHYLUM:
<span class="nc" id="L206">          return lck.getPhylumKey();</span>
        case CLASS:
<span class="nc" id="L208">          return lck.getClassKey();</span>
        case ORDER:
<span class="nc" id="L210">          return lck.getOrderKey();</span>
        case FAMILY:
<span class="nc" id="L212">          return lck.getFamilyKey();</span>
        case GENUS:
<span class="nc" id="L214">          return lck.getGenusKey();</span>
        case SUBGENUS:
<span class="nc" id="L216">          return lck.getSubgenusKey();</span>
        case SPECIES:
<span class="nc" id="L218">          return lck.getSpeciesKey();</span>
      }
    }
<span class="nc" id="L221">    return null;</span>
  }

  /**
   * Sets a higher taxon property by passing the rank of it.
   *
   * @param lck      the classification on which to set the taxon property
   * @param rank     the higher rank to set
   * @param usageKey key of the higher ranks usage
   */
  public static void setHigherRankKey(LinneanClassificationKeys lck, Rank rank, Integer usageKey) {
<span class="fc bfc" id="L232" title="All 2 branches covered.">    if (rank != null) {</span>
<span class="pc bpc" id="L233" title="8 of 9 branches missed.">      switch (rank) {</span>
        case KINGDOM:
<span class="nc" id="L235">          lck.setKingdomKey(usageKey);</span>
<span class="nc" id="L236">          break;</span>
        case PHYLUM:
<span class="nc" id="L238">          lck.setPhylumKey(usageKey);</span>
<span class="nc" id="L239">          break;</span>
        case CLASS:
<span class="nc" id="L241">          lck.setClassKey(usageKey);</span>
<span class="nc" id="L242">          break;</span>
        case ORDER:
<span class="nc" id="L244">          lck.setOrderKey(usageKey);</span>
<span class="nc" id="L245">          break;</span>
        case FAMILY:
<span class="nc" id="L247">          lck.setFamilyKey(usageKey);</span>
<span class="nc" id="L248">          break;</span>
        case GENUS:
<span class="fc" id="L250">          lck.setGenusKey(usageKey);</span>
<span class="fc" id="L251">          break;</span>
        case SUBGENUS:
<span class="nc" id="L253">          lck.setSubgenusKey(usageKey);</span>
<span class="nc" id="L254">          break;</span>
        case SPECIES:
<span class="nc" id="L256">          lck.setSpeciesKey(usageKey);</span>
          break;
      }
    }
<span class="fc" id="L260">  }</span>

  /**
   * Sets a higher taxon property by passing the rank of it.
   *
   * @param lc       the object that implements both LinneanClassification and LinneanClassificationKeys on which to set
   *                 the taxon property
   * @param rank     the higher linnean rank to set
   * @param name     the higher ranks name
   * @param usageKey key of the higher ranks usage
   */
  public static &lt;T extends LinneanClassification &amp; LinneanClassificationKeys&gt; void setHigherRank(
    T lc, Rank rank, String name, Integer usageKey
  ) {
<span class="fc" id="L274">    setHigherRank(lc, rank, name);</span>
<span class="fc" id="L275">    setHigherRankKey(lc, rank, usageKey);</span>
<span class="fc" id="L276">  }</span>

  /**
   * @return true if at least one higher rank of the classification is given, i.e. not null or empty
   */
  public static boolean hasContent(LinneanClassification lc) {
<span class="nc bnc" id="L282" title="All 2 branches missed.">    for (Rank qr : Rank.DWC_RANKS) {</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">      if (StringUtils.isNotEmpty(getHigherRank(lc, qr))) {</span>
<span class="nc" id="L284">        return true;</span>
      }
<span class="nc" id="L286">    }</span>
<span class="nc" id="L287">    return false;</span>
  }

  /**
   * Copies all linnean classification based higher taxon keys from one instance to another.
   */
  public static void copyLinneanClassificationKeys(LinneanClassificationKeys source, LinneanClassificationKeys target) {
<span class="nc bnc" id="L294" title="All 2 branches missed.">    for (Rank r : Rank.DWC_RANKS) {</span>
<span class="nc" id="L295">      setHigherRankKey(target, r, source.getHigherRankKey(r));</span>
<span class="nc" id="L296">    }</span>
<span class="nc" id="L297">  }</span>

  /**
   * Copies all linnean classification based higher taxon names from one instance to another.
   */
  public static void copyLinneanClassification(LinneanClassification source, LinneanClassification target) {
<span class="nc bnc" id="L303" title="All 2 branches missed.">    for (Rank r : Rank.DWC_RANKS) {</span>
<span class="nc" id="L304">      setHigherRank(target, r, source.getHigherRank(r));</span>
<span class="nc" id="L305">    }</span>
<span class="nc" id="L306">  }</span>

  /**
   * Utility class.
   */
  private ClassificationUtils() {
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>